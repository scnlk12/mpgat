  模型主类是 GMAN(model/model.py:9-93)，虽然名为GMAN但实现了改进的时空图注意力机制。核心结构包括:

  - 时空嵌入层 (STEmbedding): 将输入数据编码为高维特征
  - L层时空注意力块 (STAttBlock): 堆叠的时空建模单元
  - 跳跃连接: 多层特征融合
  - 输出层: 卷积层生成预测结果

  2. 核心组件详解

⏺ (1) STAttBlock - 时空注意力块 (model/model.py:151-172)

  每个块包含以下四个关键模块:

  a. 时序注意力 (temporalAttention) - model/model.py:374-470
  - 使用多头自注意力机制捕获时间依赖
  - 融合时间编码(TE): 时刻信息(time-of-day) + 星期信息(day-of-week)
  - 使用卷积增强时序上下文感知: conv1Ds_aware_temporal_context(model/model.py:404-407)
  - Pre-Norm + 残差连接 + FFN结构

  b. 因果多尺度Inception模块 (Inception_Temporal_Layer) - model/model.py:275-355
  - 多尺度卷积分支: 使用不同kernel size (2,3,6,7) 捕获不同时间尺度的模式(model/model.py:286-292)
  - 因果卷积: CausalConv1d确保只使用历史信息，防止信息泄露(model/model.py:358-371)
  - 分支融合: 通过Conv2d合并多尺度特征(model/model.py:295-301)
  - 结合时间编码的注意力机制

  c. 门控融合 (gatedFusion) - model/model.py:473-502
  - 自适应融合两个时序分支(ht1和ht2)的输出
  - 使用sigmoid门控机制: gate_value * HT1 + (1 - gate_value) * HT2
  - 动态学习最优融合权重

  d. 空间注意力 (spatialAttention) - model/model.py:175-272
  - 图结构融合: 结合学习的注意力 + 静态图结构信息
    - supports: 节点嵌入的相似度矩阵(model/model.py:237)
    - lap: 图拉普拉斯矩阵
    - 可学习权重α和β动态调整两者贡献(model/model.py:200-201, 258)
  - 掩码机制: 基于邻接矩阵过滤无效连接(model/model.py:243-244)
  - Multi-head注意力 + Pre-Norm + FFN

  (2) STEmbedding - 时空嵌入 (model/model.py:96-128)

  - 自适应嵌入: 类似位置编码，为每个时间步和节点学习独特的嵌入向量(model/model.py:112-114)
  - 通过前馈网络处理输入并融合自适应嵌入

  3. 数据处理流程 (utils/data_prepare.py)

  输入数据格式 (utils/data_prepare.py:26-57):

  - 交通流数据: shape [时间步, 节点数, 1]
  - 时间特征:
    - time_in_day: 一天中的时刻(0-287, 5分钟为一个时间片)
    - day_in_week: 星期几(0-6)
  - 最终数据shape: [时间步, 节点, 3特征]

  序列生成 (utils/data_prepare.py:15-23):

  - 滑动窗口生成样本: (历史P步, 预测Q步)
  - 默认P=12, Q=12 (即用过去1小时预测未来1小时)

  归一化 (utils/data_prepare.py:87-94):

  - 使用训练集的均值和标准差进行Z-score标准化
  - 仅对交通流数据归一化，时间特征保持原值

  4. 训练流程 (train.py)

  关键设置:

  - 损失函数: Masked MAE (忽略0值，处理缺失数据) - train.py:418
  - 优化器: Adam, 初始学习率0.001 - train.py:425
  - 学习率调度: StepLR (每100个epoch衰减0.9) - train.py:433-435
  - 早停: 验证集损失50个epoch不下降则停止 - train.py:296
  - 梯度裁剪: clip_grad=5 防止梯度爆炸 - train.py:450

  训练过程 (train.py:189-225):

  1. 提取输入x和标签y
  2. 提取时间编码TE
  3. 模型前向: out = model(x, TE)
  4. 反归一化到原始尺度
  5. 计算损失并反向传播
  6. 梯度裁剪 + 参数更新

  5. 图结构处理 (train.py:339-390)

  - 从CSV文件读取邻接矩阵(节点间连接关系)
  - 计算拉普拉斯矩阵: lap_mx, LAP = cal_lape(adj_mx) - train.py:390
  - 用于空间注意力中的结构约束

  6. 模型创新点总结

  1. 多尺度时序建模: Inception结构捕获不同周期性模式
  2. 双重时序特征: 标准注意力 + 因果Inception并行处理
  3. 自适应图结构: 静态图 + 学习图动态融合
  4. 门控融合机制: 自适应权衡不同时序表示
  5. 跳跃连接: 多层特征聚合提升性能

  7. 超参数配置 (train.py:269-313)

  | 参数         | 默认值  | 说明           |
  |------------|------|--------------|
  | P          | 12   | 历史时间步(1小时)   |
  | Q          | 12   | 预测时间步(1小时)   |
  | L          | 2    | STAttBlock层数 |
  | K          | 8    | 注意力头数        |
  | d          | 8    | 每个头的维度       |
  | batch_size | 16   | 批大小          |
  | max_epoch  | 1000 | 最大训练轮数       |

  这是一个专门为交通流量预测设计的时空图神经网络，通过多尺度时序建模和自适应图学习机制，能有效捕获交通数据的复杂时空依赖关系。